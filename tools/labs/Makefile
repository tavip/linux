KDIR=$(shell realpath $(PWD)/../..)

LABS?=$(shell cd templates && find -mindepth 1 -maxdepth 1 -type d)
TASKS?=$(shell cd templates && find $(LABS) -mindepth 1 -name Kbuild | xargs dirname)
TODO?=0

include qemu/Makefile

skels:
	cd templates && ./generate_skels.py --todo $(TODO) $(TASKS) ../skels

skels/Kbuild:
	echo "# autogenerated, do not edit " > $@
	for i in $(shell cd skels && find -mindepth 1 -name Kbuild | xargs dirname); do echo "obj-m += $$i/" >> $@; done

build: $(KCONFIG) skels/Kbuild
	$(MAKE) -C $(KDIR) M=$(PWD)/skels ARCH=$(ARCH) modules

TEMPDIR := $(shell mktemp -u)

copy:
	if  [ -e qemu.mon ]; then exit 1; fi
	mkdir $(TEMPDIR)
	sudo mount -t ext4 -o loop $(YOCTO_IMAGE) $(TEMPDIR)
	find skels -type f \( -name *.ko -or -executable \) | xargs sudo cp --parents -vt $(TEMPDIR)/home/root || true
	sudo umount $(YOCTO_IMAGE)
	rmdir $(TEMPDIR)

docs:
	$(MAKE) -C $(KDIR) DOCBOOKS= SPHINXDIRS=labs htmldocs

clean::
	rm -rf skels

.PHONY: skels
